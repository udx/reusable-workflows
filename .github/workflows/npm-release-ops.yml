name: NPM Release

on:
  workflow_call:
    inputs:
      node_version:
        description: "Node.js: Version to use (default: 22)"
        required: false
        default: "22"
        type: string
      provenance:
        description: "NPM: Enable provenance for the release (default: true)"
        required: false
        default: true
        type: boolean
      release_branch:
        description: "Branch: Deployment branch that triggers releases (default: latest)"
        required: false
        default: "latest"
        type: string
      enable_gh_release:
        description: "GitHub: Whether to create a GitHub release (default: true)"
        required: false
        default: true
        type: boolean
      dist_dir:
        description: "Common: Directory containing package.json"
        required: false
        type: string
        default: "dist"
    secrets:
      slack_webhook_url:
        description: "Slack: Webhook URL for notifications (Optional)"
        required: false

jobs:
  config:
    runs-on: ubuntu-latest
    outputs:
      node_version: ${{ steps.store_inputs.outputs.node_version }}
      provenance: ${{ steps.store_inputs.outputs.provenance }}
      release_branch: ${{ steps.store_inputs.outputs.release_branch }}
      enable_gh_release: ${{ steps.store_inputs.outputs.enable_gh_release }}
      working_directory: ${{ steps.store_inputs.outputs.working_directory }}
      dist_dir: ${{ steps.store_inputs.outputs.dist_dir }}
      current_branch: ${{ steps.branches.outputs.branch_name }}
      is_release_branch: ${{ steps.branches.outputs.is_release_branch }}
      release_version: ${{ steps.package_version.outputs.release_version }}
      package_name: ${{ steps.package_version.outputs.package_name }}
      has_test: ${{ steps.npm_scripts.outputs.has_test }}
      has_build: ${{ steps.npm_scripts.outputs.has_build }}
      has_slack_webhook: ${{ steps.check_slack.outputs.has_webhook }}
      changelog_description: ${{ steps.changelog.outputs.description }}
    env:
      WORKING_DIRECTORY: "."
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Store inputs as outputs
        id: store_inputs
        run: |

          NODE_VERSION=${{ inputs.node_version }}
          PROVENANCE=${{ inputs.provenance }}
          RELEASE_BRANCH=${{ inputs.release_branch }}
          ENABLE_GH_RELEASE=${{ inputs.enable_gh_release }}
          WORKING_DIRECTORY=${{ env.WORKING_DIRECTORY }}
          DIST_DIR=${{ inputs.dist_dir }}

          echo "Inputs Preview:"
          echo "Node version: $NODE_VERSION"
          echo "Provenance: $PROVENANCE"
          echo "Release branch: $RELEASE_BRANCH"
          echo "GitHub release: $ENABLE_GH_RELEASE"
          echo "Dist directory: $DIST_DIR"

          echo "Set output from inputs..."
          echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT
          echo "provenance=$PROVENANCE" >> $GITHUB_OUTPUT
          echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT
          echo "enable_gh_release=$ENABLE_GH_RELEASE" >> $GITHUB_OUTPUT
          echo "working_directory=$WORKING_DIRECTORY" >> $GITHUB_OUTPUT
          echo "dist_dir=$DIST_DIR" >> $GITHUB_OUTPUT

      - name: Get Package Info
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          NAME=$(node -p "require('./package.json').name")
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT
          echo "package_name=$NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Package: $NAME@$VERSION"
        working-directory: ${{ steps.store_inputs.outputs.working_directory }}

      - name: Determine Branch Information
        id: branches
        env:
          RELEASE_BRANCH: ${{ steps.store_inputs.outputs.release_branch }}
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          IS_RELEASE_BRANCH=$([[ "${BRANCH_NAME}" == "${RELEASE_BRANCH}" ]] && echo "true" || echo "false")
          echo "is_release_branch=${IS_RELEASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "üìå Branch: ${BRANCH_NAME} (Release: ${IS_RELEASE_BRANCH})"

      - name: Determine NPM Scripts
        id: npm_scripts
        run: |
          has_test=$(node -e "const scripts=require('./package.json').scripts||{};console.log((!!scripts.test));")

          if [ "$has_test" == "true" ]; then
            echo "npm test is available"
          else
            echo "npm test is not set"
          fi

          has_build=$(node -e "const scripts=require('./package.json').scripts||{};console.log((!!scripts.build));")
          if [ "$has_build" == "true" ]; then
            echo "npm build is available"
          else
            echo "npm build is not set"
          fi

          echo "has_test=$has_test" >> $GITHUB_OUTPUT
          echo "has_build=$has_build" >> $GITHUB_OUTPUT

      - name: Check Slack Webhook
        id: check_slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack_webhook_url }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: Parse Changelog
        id: changelog
        uses: actions/github-script@v8
        env:
          RELEASE_VERSION: ${{ steps.package_version.outputs.release_version }}
        with:
          script: |
            const fs = require('fs');
            const version = process.env.RELEASE_VERSION;
            let description = 'Release ' + version;

            if (fs.existsSync('./changes.md')) {
              const content = fs.readFileSync('./changes.md', 'utf8');
              const lines = content.split('\n');
              const startMarker = `### ${version}`;
              let found = false;
              let body = [];
              
              for (const line of lines) {
                if (line.startsWith(startMarker)) {
                  found = true;
                  continue;
                }
                if (found) {
                  if (line.startsWith('### ')) break;
                  body.push(line);
                }
              }
              if (body.length > 0) {
                description = body.join('\n').trim();
              }
            }
            core.setOutput('description', description);

      - name: Config summary
        run: |
          echo "NPM Release Config"
          echo "-------------------"
          echo "Node: ${{ steps.store_inputs.outputs.node_version }}"
          echo "Provenance: ${{ steps.store_inputs.outputs.provenance }}"
          echo "Release branch: ${{ steps.store_inputs.outputs.release_branch }}"
          echo "GitHub release: ${{ steps.store_inputs.outputs.enable_gh_release }}"
          echo "Working dir: ${{ steps.store_inputs.outputs.working_directory }}"
          echo "Dist dir: ${{ steps.store_inputs.outputs.dist_dir }}"
          echo "Release version: ${{ steps.package_version.outputs.release_version }}"
          echo "Package name: ${{ steps.package_version.outputs.package_name }}"
          echo "Has slack webhook: ${{ steps.check_slack.outputs.has_webhook }}"
          echo "Changelog description: ${{ steps.changelog.outputs.description }}"
          echo "Has test script: ${{ steps.npm_scripts.outputs.has_test }}"
          echo "Has build script: ${{ steps.npm_scripts.outputs.has_build }}"

  gate:
    runs-on: ubuntu-latest
    needs: config
    env:
      IS_RELEASE_BRANCH: ${{ needs.config.outputs.is_release_branch }}
      CURRENT_BRANCH: ${{ needs.config.outputs.current_branch }}
    outputs:
      release_allowed: ${{ steps.gate.outputs.release_allowed }}
    steps:
      - name: Gate check
        id: gate
        run: |
          if [ "$IS_RELEASE_BRANCH" == "true" ]; then
            echo "release_allowed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Release branch detected: $CURRENT_BRANCH"
          else
            echo "release_allowed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Non-release branch: $CURRENT_BRANCH"
          fi

  build-and-test:
    runs-on: ubuntu-latest
    needs: [config, gate]
    if: |
      always() && 
      needs.gate.result == 'success' && 
      needs.gate.outputs.release_allowed == 'true' && 
      (needs.config.outputs.has_test == 'true' || 
      needs.config.outputs.has_build == 'true')
    env:
      NODE_VERSION: ${{ needs.config.outputs.node_version }}
      WORKING_DIRECTORY: ${{ needs.config.outputs.working_directory }}
      IS_RELEASE_BRANCH: ${{ needs.config.outputs.is_release_branch }}
      HAS_TEST: ${{ needs.config.outputs.has_test }}
      HAS_BUILD: ${{ needs.config.outputs.has_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Run Build
        if: env.HAS_BUILD == 'true'
        run: |
          echo "üèóÔ∏è Running build: npm run build"
          npm run build
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Run Tests
        if: env.HAS_TEST == 'true'
        run: npm test
        working-directory: ${{ env.WORKING_DIRECTORY }}

  github-release:
    needs: [config, gate, build-and-test]
    if: |
      always() &&
      needs.gate.outputs.release_allowed == 'true' &&
      (needs.build-and-test.result == 'success' || needs.build-and-test.result == 'skipped') &&
      needs.config.outputs.is_release_branch == 'true' &&
      needs.config.outputs.enable_gh_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      IS_RELEASE_BRANCH: ${{ needs.config.outputs.is_release_branch }}
      CURRENT_BRANCH: ${{ needs.config.outputs.current_branch }}
      ENABLE_GH_RELEASE: ${{ needs.config.outputs.enable_gh_release }}
      RELEASE_VERSION: ${{ needs.config.outputs.release_version }}
      CHANGELOG_DESCRIPTION: ${{ needs.config.outputs.changelog_description }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git for Tagging
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Create Git Tag
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          git tag ${{ env.RELEASE_VERSION }}
          git push origin ${{ env.RELEASE_VERSION }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "${{ env.RELEASE_VERSION }}"
          tag_name: "${{ env.RELEASE_VERSION }}"
          body: "${{ env.CHANGELOG_DESCRIPTION }}"
          token: ${{ github.token }}

  npm-release:
    needs: [config, gate, build-and-test, github-release]
    if: |
      always() &&
      needs.gate.outputs.release_allowed == 'true' &&
      needs.build-and-test.result == 'success' &&
      (needs.github-release.result == 'success' || needs.github-release.result == 'skipped') &&
      needs.config.outputs.has_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      IS_RELEASE_BRANCH: ${{ needs.config.outputs.is_release_branch }}
      RELEASE_BRANCH: ${{ needs.config.outputs.release_branch }}
      RELEASE_VERSION: ${{ needs.config.outputs.release_version }}
      NODE_VERSION: ${{ needs.config.outputs.node_version }}
      PACKAGE_NAME: ${{ needs.config.outputs.package_name }}
      PROVENANCE: ${{ needs.config.outputs.provenance }}
      WORKING_DIRECTORY: ${{ needs.config.outputs.working_directory }}
      DIST_DIR: ${{ needs.config.outputs.dist_dir }}
      HAS_BUILD: ${{ needs.config.outputs.has_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Build
        if: env.HAS_BUILD == 'true'
        run: |
          echo "üèóÔ∏è Running build: npm run build"
          npm run build
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Publish to NPM
        if: env.IS_RELEASE_BRANCH == 'true'
        env:
          PROVENANCE: ${{ env.PROVENANCE }}
          NPM_TAG: ${{ env.RELEASE_BRANCH }}
        run: |
          echo "üö¢ Publishing to NPM..."
          PUBLISH_ARGS=()
          if [ "$PROVENANCE" == "true" ]; then
            PUBLISH_ARGS+=("--provenance")
          fi
          if [ -n "$NPM_TAG" ]; then
            PUBLISH_ARGS+=("--tag" "$NPM_TAG")
          fi
          npm publish "${PUBLISH_ARGS[@]}"
          echo "‚úÖ Successfully published $PACKAGE_NAME@$RELEASE_VERSION"
        working-directory: ${{ env.DIST_DIR }}

  report:
    runs-on: ubuntu-latest
    needs: [config, gate, npm-release, github-release]
    if: always()
    env:
      CURRENT_BRANCH: ${{ needs.config.outputs.current_branch }}
      RELEASE_BRANCH: ${{ needs.config.outputs.release_branch }}
      IS_RELEASE_BRANCH: ${{ needs.config.outputs.is_release_branch }}
      ENABLE_GH_RELEASE: ${{ needs.config.outputs.enable_gh_release }}
      NPM_RELEASE_RESULT: ${{ needs.npm-release.result }}
      GITHUB_RELEASE_RESULT: ${{ needs.github-release.result }}
    steps:
      - name: Report summary
        run: |
          echo "NPM Release Summary"
          echo "-------------------"
          echo "Branch: $CURRENT_BRANCH"
          echo "Release branch: $RELEASE_BRANCH"
          echo "Is release branch: $IS_RELEASE_BRANCH"
          echo "NPM release result: $NPM_RELEASE_RESULT"
          echo "GitHub release result: $GITHUB_RELEASE_RESULT"
          echo "Tests: npm test (if script exists)"
          echo "Build: npm run build (if script exists)"
          if [ "$IS_RELEASE_BRANCH" == "true" ]; then
            echo "Publish: enabled"
            echo "GitHub Release: $ENABLE_GH_RELEASE == 'true' && 'enabled' || 'disabled'"
          else
            echo "Publish: disabled (non-release branch)"
            echo "GitHub Release: disabled (non-release branch)"
          fi

  notify:
    runs-on: ubuntu-latest
    needs: [config, npm-release, github-release]
    if: |
      always() &&
      needs.config.outputs.has_slack_webhook == 'true' &&
      needs.config.outputs.is_release_branch == 'true'
    env:
      CURRENT_BRANCH: ${{ needs.config.outputs.current_branch }}
      PACKAGE_NAME: ${{ needs.config.outputs.package_name }}
      RELEASE_VERSION: ${{ needs.config.outputs.release_version }}
      NPM_RELEASE_RESULT: ${{ needs.npm-release.result }}
      GITHUB_RELEASE_RESULT: ${{ needs.github-release.result }}
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.slack_webhook_url }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "NPM Release for $PACKAGE_NAME: $NPM_RELEASE_RESULT == 'success' && '‚úÖ SUCCESS' || NPM_RELEASE_RESULT == 'cancelled' && '‚ö™ CANCELLED' || '‚ùå FAILED'",
              "attachments": [
                {
                  "color": "$NPM_RELEASE_RESULT == 'success' && '#36a64f' || '#ec000c'",
                  "fields": [
                    { "title": "Version", "value": "$RELEASE_VERSION", "short": true },
                    { "title": "Commit", "value": "${{ github.sha }}", "short": true }
                  ]
                }
              ]
            }
        env:
          SLACK_WEB_HOOK_URL: ${{ secrets.slack_webhook_url }}
