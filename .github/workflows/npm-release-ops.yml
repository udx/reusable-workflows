name: NPM Release

on:
  workflow_call:
    inputs:
      node_version:
        description: "Node.js: Version to use (default: 20)"
        required: false
        default: "20"
        type: string
      provenance:
        description: "NPM: Enable provenance for the release (default: true)"
        required: false
        default: true
        type: boolean
      release_branch:
        description: "Branch: Deployment branch that triggers releases (default: latest)"
        required: false
        default: "latest"
        type: string
      enable_gh_release:
        description: "GitHub: Whether to create a GitHub release (default: true)"
        required: false
        default: true
        type: boolean
      working_directory:
        description: "Common: Directory containing package.json"
        required: false
        type: string
        default: "."
    secrets:
      npm_token:
        description: "NPM: Token for publishing (Optional if OIDC/Keyless is configured)"
        required: false
      slack_webhook_url:
        description: "Slack: Webhook URL for notifications (Optional)"
        required: false

jobs:
  config:
    runs-on: ubuntu-latest
    outputs:
      current_branch: ${{ steps.branches.outputs.branch_name }}
      is_release_branch: ${{ steps.branches.outputs.is_release_branch }}
      release_version: ${{ steps.package_version.outputs.version }}
      package_name: ${{ steps.package_version.outputs.name }}
      has_slack_webhook: ${{ steps.check_slack.outputs.has_webhook }}
      changelog_description: ${{ steps.changelog.outputs.description }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Package Info
        id: package_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          NAME=$(node -p "require('./package.json').name")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Package: $NAME@$VERSION"
        working-directory: ${{ inputs.working_directory }}

      - name: Determine Branch Information
        id: branches
        env:
          RELEASE_BRANCH: ${{ inputs.release_branch }}
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          
          IS_RELEASE_BRANCH=$([[ "${BRANCH_NAME}" == "${RELEASE_BRANCH}" ]] && echo "true" || echo "false")
          echo "is_release_branch=${IS_RELEASE_BRANCH}" >> $GITHUB_OUTPUT
          echo "üìå Branch: ${BRANCH_NAME} (Release: ${IS_RELEASE_BRANCH})"

      - name: Check Slack Webhook
        id: check_slack
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.slack_webhook_url }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            echo "has_webhook=true" >> $GITHUB_OUTPUT
          else
            echo "has_webhook=false" >> $GITHUB_OUTPUT
          fi

      - name: Parse Changelog
        id: changelog
        uses: actions/github-script@v7
        env:
          RELEASE_VERSION: ${{ steps.package_version.outputs.version }}
        with:
          script: |
            const fs = require('fs');
            const version = process.env.RELEASE_VERSION;
            let description = 'Release ' + version;
            
            if (fs.existsSync('./changes.md')) {
              const content = fs.readFileSync('./changes.md', 'utf8');
              const lines = content.split('\n');
              const startMarker = `### ${version}`;
              let found = false;
              let body = [];
              
              for (const line of lines) {
                if (line.startsWith(startMarker)) {
                  found = true;
                  continue;
                }
                if (found) {
                  if (line.startsWith('### ')) break;
                  body.push(line);
                }
              }
              if (body.length > 0) {
                description = body.join('\n').trim();
              }
            }
            core.setOutput('description', description);

  gate:
    runs-on: ubuntu-latest
    needs: config
    outputs:
      release_allowed: ${{ steps.gate.outputs.release_allowed }}
    steps:
      - name: Gate check
        id: gate
        run: |
          if [ "${{ needs.config.outputs.is_release_branch }}" == "true" ]; then
            echo "release_allowed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Release branch detected: ${{ needs.config.outputs.current_branch }}"
          else
            echo "release_allowed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Non-release branch: ${{ needs.config.outputs.current_branch }}"
          fi

  build-and-test:
    runs-on: ubuntu-latest
    needs: [config, gate]
    if: always() && needs.gate.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working_directory }}/package-lock.json

      - name: Detect npm scripts
        id: scripts
        run: |
          set -e
          set -o pipefail
          node -e "const s=require('./package.json').scripts||{}; console.log('has_test='+(!!s.test)); console.log('has_build='+(!!s.build));"
        working-directory: ${{ inputs.working_directory }}

      - name: Install dependencies
        if: |
          steps.scripts.outputs.has_test == 'true' ||
          steps.scripts.outputs.has_build == 'true' ||
          needs.config.outputs.is_release_branch == 'true'
        run: npm ci
        working-directory: ${{ inputs.working_directory }}

      - name: Run Tests
        if: steps.scripts.outputs.has_test == 'true'
        run: npm test
        working-directory: ${{ inputs.working_directory }}

      - name: Run Build
        if: steps.scripts.outputs.has_build == 'true'
        run: |
          set -e
          set -o pipefail
          echo "üèóÔ∏è Running build: npm run build"
          npm run build
        working-directory: ${{ inputs.working_directory }}

  npm-release:
    needs: [config, gate, build-and-test]
    if: |
      always() &&
      needs.gate.outputs.release_allowed == 'true' &&
      needs.build-and-test.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Required for provenance
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working_directory }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ inputs.working_directory }}

      - name: Publish to NPM
        if: needs.config.outputs.is_release_branch == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.npm_token }}
          PROVENANCE: ${{ inputs.provenance }}
          NPM_TAG: ${{ inputs.release_branch }}
        run: |
          set -e
          set -o pipefail
          echo "üö¢ Publishing to NPM..."
          PUBLISH_ARGS=()
          if [ "$PROVENANCE" == "true" ]; then
            PUBLISH_ARGS+=("--provenance")
          fi
          if [ -n "$NPM_TAG" ]; then
            PUBLISH_ARGS+=("--tag" "$NPM_TAG")
          fi
          npm publish "${PUBLISH_ARGS[@]}"
          echo "‚úÖ Successfully published ${{ needs.config.outputs.package_name }}@${{ needs.config.outputs.release_version }}"
        working-directory: ${{ inputs.working_directory }}

  github-release:
    needs: [config, gate, build-and-test]
    if: |
      always() &&
      needs.gate.outputs.release_allowed == 'true' &&
      needs.build-and-test.result == 'success' &&
      needs.config.outputs.is_release_branch == 'true' &&
      inputs.enable_gh_release == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ needs.config.outputs.release_version }}"
          tag_name: "v${{ needs.config.outputs.release_version }}"
          body: ${{ needs.config.outputs.changelog_description }}
          token: ${{ github.token }}

  report:
    runs-on: ubuntu-latest
    needs: [config, gate, npm-release, github-release]
    if: always()
    steps:
      - name: Report summary
        run: |
          echo "NPM Release Summary"
          echo "-------------------"
          echo "Branch: ${{ needs.config.outputs.current_branch }}"
          echo "Release branch: ${{ inputs.release_branch }}"
          echo "Is release branch: ${{ needs.config.outputs.is_release_branch }}"
          echo "NPM release result: ${{ needs.npm-release.result }}"
          echo "GitHub release result: ${{ needs.github-release.result }}"
          echo "Tests: npm test (if script exists)"
          echo "Build: npm run build (if script exists)"
          if [ "${{ needs.config.outputs.is_release_branch }}" == "true" ]; then
            echo "Publish: enabled"
            echo "GitHub Release: ${{ inputs.enable_gh_release == true && 'enabled' || 'disabled' }}"
          else
            echo "Publish: disabled (non-release branch)"
            echo "GitHub Release: disabled (non-release branch)"
          fi

  notify:
    runs-on: ubuntu-latest
    needs: [config, npm-release, github-release]
    if: |
      always() &&
      needs.config.outputs.has_slack_webhook == 'true' &&
      needs.config.outputs.is_release_branch == 'true'
    steps:
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "NPM Release for ${{ needs.config.outputs.package_name }}: ${{ needs.npm-release.result == 'success' && '‚úÖ SUCCESS' || needs.npm-release.result == 'cancelled' && '‚ö™ CANCELLED' || '‚ùå FAILED' }}",
              "attachments": [
                {
                  "color": "${{ needs.npm-release.result == 'success' && '#36a64f' || '#ec000c' }}",
                  "fields": [
                    { "title": "Version", "value": "${{ needs.config.outputs.release_version }}", "short": true },
                    { "title": "Commit", "value": "${{ github.sha }}", "short": true }
                  ]
                }
              ]
            }
        env:
          SLACK_WEB_HOOK_URL: ${{ secrets.slack_webhook_url }}
